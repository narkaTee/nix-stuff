#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage:
  scripts/update-secrets <encrypted-yaml>

Example:
  scripts/update-secrets secrets/claw-box.yaml

Notes:
  - Uses $EDITOR.
  - Recipients come from <file-dir>/.sops.yaml.
USAGE
}

need_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Missing command: $1" >&2
    exit 1
  fi
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

if [[ $# -ne 1 ]]; then
  usage
  exit 1
fi

if [[ -z "${EDITOR:-}" ]]; then
  echo "EDITOR is not set" >&2
  exit 1
fi

FILE="$1"

need_cmd nix

CONFIG="$(dirname "$FILE")/.sops.yaml"
if [[ ! -f "$CONFIG" ]]; then
  echo "Missing SOPS config: $CONFIG" >&2
  exit 1
fi

SOPS=(nix run nixpkgs#sops -- --config "$CONFIG")

mkdir -p "$(dirname "$FILE")"

if [[ ! -f "$FILE" ]]; then
  tmp_plain="$(mktemp)"
  tmp_enc="$(mktemp)"
  trap 'rm -f "$tmp_plain" "$tmp_enc"' EXIT
  printf "{}\n" > "$tmp_plain"
  "${SOPS[@]}" \
    --encrypt \
    --input-type yaml \
    --output-type yaml \
    --filename-override "$FILE" \
    --output "$tmp_enc" \
    "$tmp_plain"
  mv "$tmp_enc" "$FILE"
fi

if ! SOPS_EDITOR="$EDITOR" "${SOPS[@]}" edit "$FILE"; then
  echo "Failed to edit secret file; ensure your local recipient is in $CONFIG" >&2
  exit 1
fi

echo "Updated: $FILE"
echo "Recipients: from config ($CONFIG)"
